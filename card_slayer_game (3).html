<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì œ ì•„ë‚´ì¾...ë­í‚¹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; transition: filter 0.3s; }
        .main-content { transition: filter 0.3s; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; padding: 20px 0; border-top: 2px solid #ccc; margin-top: 20px; }
        .character-item { --saturation: 0; text-align: center; padding: 8px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, background-color 0.5s; background-color: hsl(120, calc(20% + var(--saturation) * 30%), calc(95% - var(--saturation) * 10%)); }
        .character-item:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .character-img { width: 80px; height: 80px; object-fit: contain; border-radius: 4px; }
        .char-no-data { background-color: #fff; }
        .ranking-section { margin-bottom: 20px; background-color: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
        .ranking-container { display: flex; flex-wrap: wrap; gap: 12px; justify-content: space-around; }
        .ranking-table-wrapper { flex: 1 1 300px; min-width: 280px; }
        .ranking-table { width: 100%; border-collapse: collapse; }
        .ranking-table th, .ranking-table td { border: 1px solid #ddd; padding: 6px; text-align: center; height: 48px; vertical-align: middle; }
        .ranking-img { width: 40px; height: 40px; object-fit: contain; cursor: pointer; }
        .rating-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .rating-modal.active { display: flex; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 10px; max-width: 90%; width: 700px; max-height: 90%; overflow-y: auto; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        #modal-char-image { width: 150px; height: 150px; object-fit: contain; border: 2px solid #ccc; border-radius: 5px; margin-bottom: 12px; }
        .rating-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px; }
        @media (min-width: 768px) { .rating-options { flex-direction: row; justify-content: space-around; } }
        .score-button { padding: 6px 10px; border: 1px solid #ccc; background-color: #f9f9f9; cursor: pointer; border-radius: 4px; transition: background-color 0.1s; }
        .score-button:hover { background-color: #eee; }
        .score-button.selected { background-color: #4CAF50; color: white; border-color: #4CAF50; }
        .submit-button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 12px; width: 100%; }
        #success-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); z-index: 2000; background-color: rgba(76, 175, 80, 0.95); color: white; padding: 24px 48px; border-radius: 12px; font-size: 1.4em; font-weight: bold; opacity: 0; pointer-events: none; box-shadow: 0 0 30px rgba(0, 0, 0, 0.5); transition: opacity 0.3s; }
        @keyframes pop-in { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 80% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        #success-message.show { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 1; }
        .rank-info-section { margin-bottom: 10px; padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9; border-radius: 5px; }
        .rank-info-item { margin-bottom: 4px; font-size: 0.95em; }
        .rank-info-item strong { color: #4CAF50; }
        .rank-info-loading { color: orange; }
    </style>
</head>
<body>
    <div id="main-content" class="main-content">
        <div id="ranking-section" class="ranking-section">
            <h2 class="ranking-header">ğŸŒŸ ìºë¦­í„° ë­í‚¹ (Top 20)</h2>
            <div id="ranking-container" class="ranking-container"></div>
        </div>

        <h2 style="text-align: center; margin-top: 20px; color: #555;">ë‹ˆì¼€ ëª©ë¡</h2>
        <div id="character-grid" class="grid-container"></div>
    </div>
    
    <div id="rating-modal" class="rating-modal">
        <div class="modal-content">
            <h3 id="modal-char-title">ìºë¦­í„° í‰ê°€</h3>
            <img id="modal-char-image" src="" alt="ìºë¦­í„° ì´ë¯¸ì§€">
            <div id="modal-rank-info" class="rank-info-section">
                <div class="rank-info-loading">ë­í‚¹ ì •ë³´ ë¡œë”© ì¤‘...</div>
            </div>
            <div id="modal-rating-options" class="rating-options"></div>
            <button id="modal-submit-button" class="submit-button">í‰ê°€ ì™„ë£Œ</button>
        </div>
    </div>
    
    <div id="success-message">í‰ê°€ ì™„ë£Œ</div>

    <script>
        const SUPABASE_URL = 'https://kitkyzypxttpuhrwxmdu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdGt5enlweHR0cHVocnd4bWR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDg0MTQsImV4cCI6MjA4MTAyNDQxNH0.b1UWX8Zw1rH7TJUnSDcSh0OpHL_qLRIDBOQQ7QzLQtU';
        const SUPABASE_TABLE = 'ForNikkeTier';

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            global: {
                headers: {
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'apikey': SUPABASE_ANON_KEY
                }
            }
        });

        let currentRatingCharId = null;
        let cachedRankingData = null;
        let cachedById = new Map();

        const SCORE_COLUMNS = 'id, wife_avg_score, wife_count, girlfriend_avg_score, girlfriend_count, daughter_avg_score, daughter_count';
        const CHARACTER_IDS = [
            '010','011','012','013','014','015','016','017','020','022','023','030','032','033','040','041','043','060','061','062','070','071','072','073','074','075','080','082','090','091','092','093','094','095','100','101','102','103','104','105','110','111','112','120','121','130','131','132','140','141','142','143','150','160','161','162','170','171','172','180','181','182','183','190','191','192','193','194','195','200','201','202','203','210','212','220','221','222','223','224','225','226','227','230','231','232','233','234','240','241','242','250','251','252','253','254','255','260','261','262','263','270','271','272','280','281','282','283','284','290','291','300','301','302','303','304','305','306','307','308','310','311','312','313','314','315','321','330','331','350','351','352','353','354','355','361','370','371','380','381','382','390','391','392','400','401','402','403','411','412','430','431','432','440','441','450','451','470','480','481','482','490','491','500','501','502','510','511','513','514','520','521','530','531','532','550','551','560','561','562','563','570','580','581','590','600','601','800','801','802','803','804','810','811','812','813','820','821','822','830','831','832','833','834','835','836','840','841','842','850','851','852','853','900','901','902','903','904','905','907','908','910','911','912','914','915','916','917','918','919','920','921','922','923','924','925','928','929','930','931','932','933','934','935','936','937','939','940','941','942','943','944','945','946','947','948','951','952','960','961','962','963','964','965','966','967','968','969','970','971','973','974','975','976','977','979','980','981','982','983','985','988','989','990','991','992','993','994'
        ];

        const CATEGORIES = ['ì•„ë‚´', 'ì—¬ìì¹œêµ¬', 'ë”¸'];

        const CATEGORY_MAP = {
            'ì•„ë‚´': 'wife',
            'ì—¬ìì¹œêµ¬': 'girlfriend',
            'ë”¸': 'daughter'
        };

        const SCORE_TEXTS = {
            1: 'ã…—', 2: 'ì ˆëŒ€ ì•ˆë¨', 3: 'ë¶ˆê°€ëŠ¥', 4: 'ë˜ê² ëƒ?', 5: 'ã„´ã„´',
            6: 'ã…‡ã…‡', 7: 'ê°€ëŠ¥', 8: 'ìŒ‰ê°€ëŠ¥', 9: 'ê°œì‹¸ã…ƒê°€ëŠ¥', 10: 'ì´ê¶ˆê¶ˆë˜~'
        };

        function getNikkeSprite(id) {
            return `https://nikke-db-legacy.pages.dev/images/sprite/si_c${id}_00_s.png`;
        }

        function showSuccessMessage() {
            const successMessage = document.getElementById('success-message');
            successMessage.classList.add('show');
            setTimeout(() => successMessage.classList.remove('show'), 1500);
        }

        function displayCharacterRankInfo(charId, rankingData) {
            const rankInfoDiv = document.getElementById('modal-rank-info');
            if (!rankingData) {
                rankInfoDiv.innerHTML = `<div class="rank-info-loading">ë­í‚¹ ë°ì´í„°ê°€ ìºì‹±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„í•˜ì„¸ìš”.</div>`;
                return;
            }

            let html = '';
            CATEGORIES.forEach(category => {
                const prefix = CATEGORY_MAP[category];
                const avgKey = `${prefix}_avg_score`;
                const countKey = `${prefix}_count`;

                const dataArr = rankingData[category] || [];
                const charEntry = dataArr.find(item => item.id === charId);

                if (charEntry && (charEntry[countKey] > 0)) {
                    const rank = dataArr.findIndex(item => item.id === charId) + 1;
                    const score = parseFloat(charEntry[avgKey] || 0).toFixed(2);
                    html += `<div class="rank-info-item"><strong>${category}:</strong> í‰ê·  ${score}ì , í˜„ì¬ ë“±ìˆ˜: <strong>${rank}ìœ„</strong> (ì´ ${charEntry[countKey]}í‘œ)</div>`;
                } else {
                    html += `<div class="rank-info-item"><strong>${category}:</strong> ì•„ì§ í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                }
            });

            rankInfoDiv.innerHTML = html;
        }

        async function openRatingModal(charId) {
            currentRatingCharId = charId;
            const modal = document.getElementById('rating-modal');
            const optionsContainer = document.getElementById('modal-rating-options');
            document.getElementById('modal-char-image').src = getNikkeSprite(charId);
            document.getElementById('modal-rank-info').innerHTML = `<div class="rank-info-loading">ë­í‚¹ ì •ë³´ ë¡œë”© ì¤‘...</div>`;

            if (!cachedRankingData) await fetchRankings();
            displayCharacterRankInfo(charId, cachedRankingData);

            optionsContainer.innerHTML = '';
            CATEGORIES.forEach(category => {
                let itemHtml = `\n                    <div class="rating-item-modal" data-category="${category}">\n                        <strong>${category}:</strong>\n                        <span class="score-display" data-category="${category}">5ì  (ã„´ã„´)</span>\n                        <div class="score-buttons-modal" data-category="${category}">\n                `;
                for (let i = 1; i <= 10; i++) {
                    const isDefault = i === 5 ? 'selected' : '';
                    itemHtml += `<button class="score-button ${isDefault}" data-score="${i}" data-category="${category}">${i}</button>`;
                }
                itemHtml += `</div></div>`;
                optionsContainer.innerHTML += itemHtml;
            });

            optionsContainer.querySelectorAll('.score-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const score = parseInt(e.target.dataset.score);
                    const category = e.target.dataset.category;
                    const scoreButtons = optionsContainer.querySelector(`.score-buttons-modal[data-category="${category}"]`);
                    scoreButtons.querySelectorAll('.score-button').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    const display = optionsContainer.querySelector(`.score-display[data-category="${category}"]`);
                    display.textContent = `${score}ì  (${SCORE_TEXTS[score]})`;
                });
            });

            modal.classList.add('active');
            document.getElementById('main-content').style.filter = 'blur(5px)';
        }

        function closeRatingModal() {
            document.getElementById('rating-modal').classList.remove('active');
            document.getElementById('main-content').style.filter = 'none';
            currentRatingCharId = null;
        }

        function renderCharacterGrid() {
            const grid = document.getElementById('character-grid');
            grid.innerHTML = '';

            const totalCounts = new Map();
            let maxTotalCount = 0;

            CHARACTER_IDS.forEach(id => {
                const raw = cachedById.get(id) || {};
                const total = (raw.wife_count || 0) + (raw.girlfriend_count || 0) + (raw.daughter_count || 0);
                totalCounts.set(id, total);
                if (total > maxTotalCount) maxTotalCount = total;
            });

            CHARACTER_IDS.forEach(id => {
                const totalCount = totalCounts.get(id) || 0;
                const item = document.createElement('div');
                let saturationRatio = 0;
                if (maxTotalCount > 0 && totalCount > 0) {
                    saturationRatio = Math.min(1.0, 0.1 + (0.9 * totalCount / maxTotalCount));
                }
                item.className = `character-item ${totalCount === 0 ? 'char-no-data' : ''}`;
                item.dataset.charId = id;
                item.style.setProperty('--saturation', saturationRatio.toFixed(3));
                const displayCount = Math.floor(totalCount / 3);
                item.innerHTML = `\n                    <img src="${getNikkeSprite(id)}" alt="ìºë¦­í„° ${id}" class="character-img">\n                    <small>(${displayCount}í‘œ)</small>\n                `;
                item.addEventListener('click', (e) => { if (e.target.closest('.character-item') === item) openRatingModal(id); });
                grid.appendChild(item);
            });
        }

        document.getElementById('modal-submit-button').addEventListener('click', async () => {
            if (!currentRatingCharId) return;
            const panel = document.getElementById('modal-rating-options');
            const charId = currentRatingCharId;
            const ratings = {};
            let allRated = true;
            CATEGORIES.forEach(category => {
                const selectedButton = panel.querySelector(`.score-buttons-modal[data-category="${category}"] .score-button.selected`);
                if (!selectedButton) { allRated = false; return; }
                ratings[category] = parseInt(selectedButton.dataset.score);
            });
            if (!allRated) { alert('ëª¨ë“  í•­ëª©ì„ í‰ê°€í•´ì•¼ ì™„ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }

            try {
                let { data, error } = await client
                    .from(SUPABASE_TABLE)
                    .select(SCORE_COLUMNS)
                    .eq('id', charId)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                let wife_score = ratings['ì•„ë‚´'];
                let wife_count = 1;
                let girlfriend_score = ratings['ì—¬ìì¹œêµ¬'];
                let girlfriend_count = 1;
                let daughter_score = ratings['ë”¸'];
                let daughter_count = 1;

                if (data) {
                    wife_score = ((data.wife_avg_score || 0) * (data.wife_count || 0) + ratings['ì•„ë‚´']) / ((data.wife_count || 0) + 1);
                    wife_count = (data.wife_count || 0) + 1;
                    girlfriend_score = ((data.girlfriend_avg_score || 0) * (data.girlfriend_count || 0) + ratings['ì—¬ìì¹œêµ¬']) / ((data.girlfriend_count || 0) + 1);
                    girlfriend_count = (data.girlfriend_count || 0) + 1;
                    daughter_score = ((data.daughter_avg_score || 0) * (data.daughter_count || 0) + ratings['ë”¸']) / ((data.daughter_count || 0) + 1);
                    daughter_count = (data.daughter_count || 0) + 1;

                    const { error: updateError } = await client
                        .from(SUPABASE_TABLE)
                        .update({ 
                            wife_avg_score: parseFloat(wife_score.toFixed(4)), wife_count: wife_count,
                            girlfriend_avg_score: parseFloat(girlfriend_score.toFixed(4)), girlfriend_count: girlfriend_count,
                            daughter_avg_score: parseFloat(daughter_score.toFixed(4)), daughter_count: daughter_count,
                            created_at: new Date().toISOString(),
                        })
                        .eq('id', charId);

                    if (updateError) throw updateError;
                } else {
                    const { error: insertError } = await client
                        .from(SUPABASE_TABLE)
                        .insert([{ id: charId, wife_avg_score: parseFloat(wife_score.toFixed(4)), wife_count: wife_count, girlfriend_avg_score: parseFloat(girlfriend_score.toFixed(4)), girlfriend_count: girlfriend_count, daughter_avg_score: parseFloat(daughter_score.toFixed(4)), daughter_count: daughter_count, created_at: new Date().toISOString() }]);
                    if (insertError) throw insertError;
                }

                closeRatingModal();
                showSuccessMessage();
                await fetchRankings();

            } catch (error) {
                console.error('Supabase ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error.message || error);
                alert(`í‰ê°€ ì €ì¥ ì‹¤íŒ¨: ${error.message || error}`);
            }
        });

        async function fetchRankings() {
            const rankingContainer = document.getElementById('ranking-container');
            rankingContainer.innerHTML = 'ë°ì´í„° ë¡œë”© ì¤‘...';

            try {
                const { data, error } = await client
                    .from(SUPABASE_TABLE)
                    .select(SCORE_COLUMNS);

                if (error) throw error;

                cachedById = new Map();
                (data || []).forEach(item => cachedById.set(item.id, item));

                const rankingData = {};

                CATEGORIES.forEach(category => {
                    const prefix = CATEGORY_MAP[category];
                    const avgKey = `${prefix}_avg_score`;
                    const arr = (data || []).map(item => ({ ...item, _avg_for_sort: item[avgKey] == null ? 0 : item[avgKey] }));
                    arr.sort((a, b) => b._avg_for_sort - a._avg_for_sort);
                    rankingData[category] = arr;
                });

                cachedRankingData = rankingData;

                renderRankingTables(rankingData);
                renderCharacterGrid();

            } catch (error) {
                console.error('ë­í‚¹ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error.message || error);
                rankingContainer.innerHTML = `âš ï¸ ë­í‚¹ ë¡œë”© ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”. (Error: ${error.message || error})`;
                cachedById = new Map();
                renderCharacterGrid();
            }
        }

        function renderRankingTables(rankings) {
            const rankingContainer = document.getElementById('ranking-container');
            rankingContainer.innerHTML = '';

            CATEGORIES.forEach(category => {
                const prefix = CATEGORY_MAP[category];
                const avgKey = `${prefix}_avg_score`;
                const countKey = `${prefix}_count`;
                const data = rankings[category] || [];

                let tableHtml = `<div class="ranking-table-wrapper"><h3>${category} ë­í‚¹</h3><table class="ranking-table"><thead><tr><th>ìˆœìœ„</th><th>ì´ë¯¸ì§€</th><th>í‰ê·  ì ìˆ˜</th><th>íˆ¬í‘œìˆ˜</th></tr></thead><tbody>`;

                if (data.length === 0) {
                    tableHtml += `<tr><td colspan="4">ì°¸ì—¬ìê°€ ìˆëŠ” ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                } else {
                    data.slice(0, 20).forEach((item, index) => {
                        const score = item[avgKey] ? parseFloat(item[avgKey]).toFixed(2) : (item._avg_for_sort ? parseFloat(item._avg_for_sort).toFixed(2) : '0.00');
                        const votes = item[countKey] || 0;
                        tableHtml += `\n                            <tr class="ranking-row">\n                                <td>${index + 1}</td>\n                                <td><img src="${getNikkeSprite(item.id)}" alt="ìºë¦­í„° ${item.id}" class="ranking-img" data-char-id="${item.id}"></td>\n                                <td>${score}</td>\n                                <td>${votes}</td>\n                            </tr>\n                        `;
                    });
                }

                tableHtml += `</tbody></table></div>`;
                rankingContainer.innerHTML += tableHtml;
            });

            rankingContainer.querySelectorAll('.ranking-img').forEach(img => {
                img.addEventListener('click', (e) => openRatingModal(e.target.dataset.charId));
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchRankings();
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && document.getElementById('rating-modal').classList.contains('active')) closeRatingModal(); });
        });
    </script>
</body>
</html>
